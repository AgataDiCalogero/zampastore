<section class="cart-page section">
  <h1 class="cart-title">Carrello</h1>

  @if (state(); as currentState) { @if (currentState.status === 'ready') {
  <form class="cart-layout" [formGroup]="form">
    <div class="cart-items">
      @for (cartItem of currentState.items; track cartItem.product.id; let i =
      $index) {
      <div class="cart-item-card" [formGroup]="itemsArray.controls[i]">
        @if (cartItem.product.imageUrl) {
        <div class="item-image">
          <img
            [ngSrc]="cartItem.product.imageUrl"
            [alt]="cartItem.product.name"
            width="64"
            height="64"
          />
        </div>
        }

        <div class="item-info">
          <div class="item-name">{{ cartItem.product.name }}</div>
          <div class="item-unit-price">
            {{ cartItem.product.priceCents / 100 | number: '1.2-2' }} €
          </div>
        </div>

        <div class="item-qty">
          <p-inputNumber
            formControlName="quantity"
            [showButtons]="true"
            buttonLayout="horizontal"
            [minFractionDigits]="0"
            [maxFractionDigits]="0"
            incrementButtonIcon="pi pi-plus"
            decrementButtonIcon="pi pi-minus"
            [inputStyle]="{ width: '2.5rem', 'text-align': 'center' }"
            ariaLabel="Quantità"
          ></p-inputNumber>
        </div>

        <div class="item-total">
          {{ (cartItem.product.priceCents * cartItem.qty) / 100 | number:
          '1.2-2' }} €
        </div>

        <button
          pButton
          type="button"
          icon="pi pi-trash"
          class="p-button-text p-button-danger p-button-rounded item-remove"
          aria-label="Rimuovi"
          (click)="removeItem(cartItem.product.id)"
          pTooltip="Rimuovi"
          tooltipPosition="left"
        ></button>
      </div>
      }
    </div>

    <aside class="cart-summary">
      <div class="summary-total-row">
        <span>Totale</span>
        <strong>{{ cartTotal() | number: '1.2-2' }} €</strong>
      </div>

      <div class="summary-actions">
        <p-button
          label="Vai al checkout"
          icon="pi pi-arrow-right"
          iconPos="right"
          styleClass="checkout-cta"
          (onClick)="confirmOrder()"
        ></p-button>

        <button
          pButton
          type="button"
          class="p-button-text p-button-danger p-button-sm clear-cart-btn"
          icon="pi pi-trash"
          label="Svuota carrello"
          (click)="clearCart()"
        ></button>
      </div>
    </aside>
  </form>
  <p-confirmDialog key="clear-cart"></p-confirmDialog>
  } @else if (currentState.status === 'empty') {
  <div class="cart-empty">
    <div class="empty-state">
      <i class="pi pi-shopping-bag"></i>
      <h3>Il carrello è vuoto</h3>
      <p>Scegli i migliori prodotti per il tuo animale.</p>
      <button pButton type="button" [routerLink]="['/prodotti']">
        Vai al catalogo
      </button>
    </div>
  </div>
  } @else {
  <div class="cart-skeleton">
    @for (row of skeletonRows; track $index) {
    <div class="cart-skeleton-row">
      <p-skeleton height="80px" width="80px" borderRadius="12px"></p-skeleton>
      <div class="cart-skeleton-text">
        <p-skeleton height="18px" width="60%"></p-skeleton>
        <p-skeleton height="14px" width="30%"></p-skeleton>
      </div>
    </div>
    }
  </div>
  } }
</section>
