@if (state$ | async; as state) { @if (state.status === 'ready') {
<section class="order-detail section">
  <nav class="order-breadcrumb">
    <a [routerLink]="['/ordini']">Ordini</a>
    <span>/</span>
    <span>#{{ getShortId(state.order.id) }}</span>
  </nav>
  <p-card class="order-card" header="Dettaglio ordine">
    <div class="order-header-grid">
      <div class="meta-item">
        <span class="meta-label">Riferimento</span>
        <span class="meta-value">#{{ getShortId(state.order.id) }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Data</span>
        <span class="meta-value">
          {{ state.order.createdAt | date: 'dd/MM/yyyy' }}
        </span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Stato</span>
        <span
          class="status-chip"
          [class]="'status-chip status-' + statusFor(state.order.status).tone"
        >
          {{ statusFor(state.order.status).label }}
        </span>
      </div>
      <div class="meta-item meta-total">
        <span class="meta-label">Totale</span>
        <span class="meta-value">
          {{ state.order.totalCents / 100 | number: '1.2-2' }} €
        </span>
      </div>
    </div>

    <h4>Spedizione</h4>
    <div class="shipping-box">
      <div>
        {{ state.order.shippingAddress.firstName }} {{
        state.order.shippingAddress.lastName }}
      </div>
      <div>{{ state.order.shippingAddress.address }}</div>
      <div>
        {{ state.order.shippingAddress.postalCode }} {{
        state.order.shippingAddress.city }}
      </div>
      <div>{{ state.order.shippingAddress.country }}</div>
    </div>

    <h4>Prodotti</h4>
    @defer (on viewport) {
    <!-- Desktop Table -->
    <div class="desktop-view">
      <p-table
        [value]="state.order.items"
        dataKey="productId"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th scope="col">Prodotto</th>
            <th scope="col">Prezzo</th>
            <th scope="col">Qtà</th>
            <th scope="col">Totale</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>
              <div class="flex align-items-center gap-3">
                @if (item.imageUrl) {
                <img
                  [src]="item.imageUrl"
                  [alt]="item.name"
                  width="40"
                  class="shadow-1 border-round"
                />
                }
                <span>{{ item.name }}</span>
              </div>
            </td>
            <td>{{ item.unitPriceCents / 100 | number: '1.2-2' }} €</td>
            <td>{{ item.qty }}</td>
            <td>{{ item.lineTotalCents / 100 | number: '1.2-2' }} €</td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Mobile List -->
    <div class="mobile-view">
      @for (item of state.order.items; track item.productId) {
      <div class="product-card-mobile">
        @if (item.imageUrl) {
        <div class="product-image">
          <img [src]="item.imageUrl" [alt]="item.name" loading="lazy" />
        </div>
        }
        <div class="product-details">
          <span class="product-name">{{ item.name }}</span>
          <div class="product-meta">
            <span class="product-qty">Qtà: {{ item.qty }}</span>
            <span class="product-price">
              {{ item.unitPriceCents / 100 | number: '1.2-2' }} €
            </span>
          </div>
        </div>
        <div class="product-total">
          {{ item.lineTotalCents / 100 | number: '1.2-2' }} €
        </div>
      </div>
      }
    </div>
    } @placeholder {
    <div class="order-skeleton">
      <p-skeleton height="28px"></p-skeleton>
      <p-skeleton height="28px"></p-skeleton>
      <p-skeleton height="28px"></p-skeleton>
    </div>
    }

    <div class="order-actions">
      <button
        pButton
        type="button"
        class="p-button-text btn-back"
        [routerLink]="['/ordini']"
      >
        <i class="pi pi-arrow-left mr-2"></i>
        Torna agli ordini
      </button>
    </div>
  </p-card>
</section>
} @else if (state.status === 'not-found') {
<section class="order-empty section">
  <div class="empty-state">
    <i class="pi pi-inbox"></i>
    <h3>Ordine non trovato</h3>
    <p>Controlla il codice ordine o torna alla lista.</p>
    <button pButton type="button" [routerLink]="['/ordini']">
      Vai agli ordini
    </button>
  </div>
</section>
} @else if (state.status === 'error') {
<section class="order-empty section">
  <div class="empty-state">
    <i class="pi pi-exclamation-triangle"></i>
    <h3>Errore di caricamento</h3>
    <p>Riprova tra poco.</p>
  </div>
</section>
} @else {
<section class="order-detail section">
  <p-card class="order-card" header="Dettaglio ordine">
    <div class="order-skeleton">
      <p-skeleton height="28px"></p-skeleton>
      <p-skeleton height="28px"></p-skeleton>
      <p-skeleton height="28px"></p-skeleton>
    </div>
  </p-card>
</section>
} }
